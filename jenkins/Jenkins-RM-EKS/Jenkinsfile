pipeline {
    agent any

    environment {
        AWS_REGION = 'us-east-2'
        CLUSTER_NAME = 'microservice-cluster'
        EKSCTL_PATH = "${WORKSPACE}/eksctl"
    }

    stages {
        stage('Checkout') {
            steps {
                git url: 'https://github.com/ghassan8080/DevOps-Pipeline.git', branch: 'main'
            }
        }

        stage('Install eksctl') {
            steps {
                sh '''
                    echo "=== Installing eksctl ==="
                    # تحميل وفك ضغط eksctl
                    curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
                    # منح الصلاحيات والنقل إلى مسار العمل
                    chmod +x /tmp/eksctl
                    mv /tmp/eksctl ${EKSCTL_PATH}
                    # التحقق من التثبيت
                    ${EKSCTL_PATH} version
                '''
            }
        }

        stage('Delete EKS Cluster') {
            steps {
                withAWS(credentials: 'aws-credentials', region: env.AWS_REGION) {
                    sh '''
                        echo "=== Deleting EKS Cluster ==="
                        # حذف المجموعة مع تجاهل الأخطاء إذا لم تكن المجموعة موجودة
                        ${EKSCTL_PATH} delete cluster --name ${CLUSTER_NAME} --region ${AWS_REGION} --wait || echo "Cluster may not exist or already deleted"
                    '''
                }
            }
        }
    }

    post {
        success {
            echo 'EKS Cluster deleted successfully!'
        }
        failure {
            echo 'EKS Cluster deletion failed!'
        }
    }
}
