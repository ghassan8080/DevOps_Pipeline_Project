#!/bin/bash

# scripts/fix-init-system-helpers.sh
echo "๐ง ุฅุตูุงุญ ูุดููุฉ init-system-helpers..."

# ุชุญุฏูุซ ุงููุธุงู
echo "๐ฆ ุชุญุฏูุซ ุงููุธุงู..."
sudo apt update

# ุฅุถุงูุฉ ูุณุชูุฏุน ุฑุณูู ูุญุชูู ุนูู ุงูุฅุตุฏุงุฑ ุงูุฃุญุฏุซ ูู init-system-helpers
echo "๐ ุฅุถุงูุฉ ูุณุชูุฏุน ูุญุชูู ุนูู ุฅุตุฏุงุฑ ุฃุญุฏุซ ูู init-system-helpers..."

# ุฅุถุงูุฉ ูุณุชูุฏุน Ubuntu Main
echo "๐ฆ ุฅุถุงูุฉ ูุณุชูุฏุน Ubuntu Main..."
sudo apt-add-repository "deb http://us-east-2.ec2.archive.ubuntu.com/ubuntu/ bionic main" -y
sudo apt update

# ุชุซุจูุช init-system-helpers ูู ุงููุณุชูุฏุฑ ุงูุฑุฆูุณู
echo "๐ง ุชุซุจูุช init-system-helpers ูู ุงููุณุชูุฏุน ุงูุฑุฆูุณู..."
sudo apt install --only-upgrade init-system-helpers -y

# ุงูุชุญูู ูู ุงูุฅุตุฏุงุฑ ุงูุฌุฏูุฏ
echo "๐ ุงูุชุญูู ูู ุงูุฅุตุฏุงุฑ ุงูุฌุฏูุฏ..."
INSTALLED_VERSION=$(dpkg -l init-system-helpers | grep ii | awk '{print $3}')
echo "ุงูุฅุตุฏุงุฑ ุงููุซุจุช: $INSTALLED_VERSION"

# ุฅุฐุง ูุงู ุงูุฅุตุฏุงุฑ ูุง ูุฒุงู ุฃูู ูู 1.54ุ ุฌุฑุจ ุทุฑููุฉ ุฃุฎุฑู
if [[ "$INSTALLED_VERSION" < "1.54" ]]; then
    echo "โ๏ธ ุงูุฅุตุฏุงุฑ ูุง ูุฒุงู ุฃูู ูู ุงููุทููุจุ ุฌุฑุจ ุทุฑููุฉ ุฃุฎุฑู..."

    # ุฌูุจ ุญุฒูุฉ ูุจุงุดุฑุฉ ูู ูุณุชูุฏุน Ubuntu
    cd /tmp
    wget http://us-east-2.ec2.archive.ubuntu.com/ubuntu/pool/main/i/init-system-helpers/init-system-helpers_1.54~bpo8+1_all.deb
    sudo dpkg -i init-system-helpers_1.54~bpo8+1_all.deb

    # ุงูุชุญูู ูู ุงูุฅุตุฏุงุฑ ูุฑุฉ ุฃุฎุฑู
    INSTALLED_VERSION=$(dpkg -l init-system-helpers | grep ii | awk '{print $3}')
    echo "ุงูุฅุตุฏุงุฑ ุงูุฌุฏูุฏ: $INSTALLED_VERSION"
fi

# ุงูุขู ุญุงูู ุชุซุจูุช Jenkins
echo "๐จโ๐ป ูุญุงููุฉ ุชุซุจูุช Jenkins..."
sudo apt install -y jenkins

# ุงูุชุฃูุฏ ูู ูุฌูุฏ ูุณุชุฎุฏู jenkins
echo "๐ค ุงูุชุฃูุฏ ูู ูุฌูุฏ ูุณุชุฎุฏู jenkins..."
if ! id "jenkins" &>/dev/null; then
    echo "ุฅูุดุงุก ูุณุชุฎุฏู jenkins..."
    sudo useradd -r -s /bin/false jenkins
else
    echo "ูุณุชุฎุฏู jenkins ููุฌูุฏ ุจุงููุนู"
fi

# ุฅูุดุงุก ูููุงุช Jenkins ุงููุงุฒูุฉ
echo "๐ ุฅูุดุงุก ูููุงุช Jenkins ุงููุงุฒูุฉ..."
sudo mkdir -p /var/lib/jenkins /var/cache/jenkins /var/log/jenkins
sudo chown -R jenkins:jenkins /var/lib/jenkins /var/cache/jenkins /var/log/jenkins

# ุฅูุดุงุก ููู ุฎุฏูุฉ Jenkins
echo "๐ ุฅุนุฏุงุฏ ุฎุฏูุฉ Jenkins..."
sudo tee /lib/systemd/system/jenkins.service > /dev/null <<EOL
[Unit]
Description=Jenkins Continuous Integration Server
After=network.target

[Service]
User=jenkins
Group=jenkins
Environment="JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64"
ExecStart=/usr/bin/java -jar /usr/share/jenkins/jenkins.war
ExecReload=/bin/kill -HUP \$MAINPID
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOL

# ุฅุนุงุฏุฉ ุชุดุบูู systemd
echo "๐ ุฅุนุงุฏุฉ ุชุดุบูู systemd..."
sudo systemctl daemon-reload

# ุชุนุฏูู ุฃุฐููุงุช ูููุงุช Jenkins
echo "๐ ุชุนุฏูู ุฃุฐููุงุช ูููุงุช Jenkins..."
sudo chown -R jenkins:jenkins /var/lib/jenkins
sudo chown -R jenkins:jenkins /var/cache/jenkins
sudo chown -R jenkins:jenkins /var/log/jenkins

# ุชุดุบูู Jenkins
echo "๐ ุชุดุบูู Jenkins..."
sudo systemctl enable jenkins
sudo systemctl start jenkins

# ุงูุชุญูู ูู ุญุงูุฉ Jenkins
echo "๐ ุงูุชุญูู ูู ุญุงูุฉ Jenkins..."
sudo systemctl status jenkins

# ุนุฑุถ ูููุฉ ุงููุฑูุฑ ุงูุฃูููุฉ
echo ""
echo "๐ ูุนูููุงุช ูููุฉ:"
echo "1. ูููุฉ ูุฑูุฑ Jenkins ุงูุฃูููุฉ:"
sudo cat /var/lib/jenkins/secrets/initialAdminPassword 2>/dev/null || echo "Jenkins ูู ูุชู ุชุดุบููู ุจุนุฏ"
echo "2. ุฑุงุจุท Jenkins: http://$(curl -s ifconfig.me):8080"
